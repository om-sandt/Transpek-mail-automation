{% extends "base.html" %}

{% block title %}Reject Request #{{ request.id }} - Approval Workflow{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h3 class="mb-0">
                    <i class="fas fa-times-circle"></i> Reject Request #{{ request.id }}
                </h3>
            </div>
            <div class="card-body">
                <!-- Request Details -->
                <div class="mb-4">
                    <h5><i class="fas fa-info-circle"></i> Request Details</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Request ID:</strong> #{{ request.id }}</p>
                            <p><strong>Approver Email:</strong> {{ request.approver_email }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> 
                                <span class="badge bg-warning">Pending</span>
                            </p>
                            <p><strong>Created:</strong> {{ request.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label"><strong>Request Data:</strong></label>
                        <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                            <pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">{{ request.data }}</pre>
                        </div>
                    </div>
                </div>

                <!-- Rejection Form -->
                <form method="POST" action="{{ url_for('process') }}" id="rejectForm">
                    <input type="hidden" name="request_id" value="{{ request.id }}">
                    <input type="hidden" name="status" value="Rejected">
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">
                            <i class="fas fa-exclamation-triangle"></i> Rejection Reason <span class="text-danger">*</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="reason" 
                            name="reason" 
                            rows="4" 
                            placeholder="Please provide a detailed reason for rejecting this request..."
                            required
                        ></textarea>
                        <div class="form-text">
                            <strong>Required:</strong> Please provide a clear explanation for why this request is being rejected.
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Rejecting this request will prevent it from proceeding. Please ensure you have thoroughly reviewed the request before making this decision.
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-danger" id="rejectBtn">
                            <i class="fas fa-times"></i> Reject Request
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Action History -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> Action History
                </h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Request Submitted</h6>
                            <p class="text-muted mb-0">{{ request.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Pending Approval</h6>
                            <p class="text-muted mb-0">Awaiting your decision</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.timeline-content h6 {
    margin-bottom: 5px;
    font-weight: 600;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: -20px;
    top: 30px;
    bottom: -20px;
    width: 2px;
    background-color: #dee2e6;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Form validation
document.getElementById('rejectForm').addEventListener('submit', function(e) {
    const reason = document.getElementById('reason').value.trim();
    
    if (!reason) {
        e.preventDefault();
        alert('Please provide a reason for rejection.');
        document.getElementById('reason').focus();
        return false;
    }
    
    // Confirm rejection
    if (!confirm('Are you sure you want to reject this request? This action cannot be undone.')) {
        e.preventDefault();
        return false;
    }
});

// Character counter for reason field
document.getElementById('reason').addEventListener('input', function() {
    const maxLength = 1000;
    const currentLength = this.value.length;
    const remaining = maxLength - currentLength;
    
    let counter = document.getElementById('reason-counter');
    if (!counter) {
        counter = document.createElement('div');
        counter.id = 'reason-counter';
        counter.className = 'form-text';
        this.parentNode.appendChild(counter);
    }
    
    if (currentLength > maxLength * 0.9) {
        counter.className = 'form-text text-warning';
    } else if (currentLength === 0) {
        counter.className = 'form-text text-danger';
    } else {
        counter.className = 'form-text';
    }
    
    counter.textContent = `${currentLength} characters (${remaining} remaining)`;
    
    // Update button state
    const rejectBtn = document.getElementById('rejectBtn');
    if (currentLength === 0) {
        rejectBtn.disabled = true;
        rejectBtn.innerHTML = '<i class="fas fa-times"></i> Provide Reason First';
    } else {
        rejectBtn.disabled = false;
        rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject Request';
    }
});
</script>
{% endblock %} 